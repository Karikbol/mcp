<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Вход</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 16px; margin: 0; background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
    .card { background: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 16px; border-radius: 12px; margin-top: 12px; }
    a { color: var(--tg-theme-link-color, #2481cc); }
  </style>
</head>
<body>
  <div id="app">
    <p>Загрузка...</p>
  </div>
  <script>
    (function() {
      const params = new URLSearchParams(location.search);
      const session = params.get('session');
      const app = document.getElementById('app');
      if (!session) {
        app.innerHTML = '<p>Вы не зарегистрированы.</p><p><a href="/webapp/register">Регистрация</a></p>';
        return;
      }
      var initData = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || '';
      var headers = { 'Accept': 'application/json' };
      if (initData) headers['x-telegram-init-data'] = initData;
      fetch('/api/login?session=' + encodeURIComponent(session), { headers: headers })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          app.innerHTML = '<h1>Вы зарегистрированы ✅</h1>' +
            '<div class="card">' +
            '<p><strong>Имя:</strong> ' + (data.first_name || '') + ' ' + (data.last_name || '') + '</p>' +
            '<p><strong>Телефон:</strong> ' + (data.phone_masked || '') + '</p>' +
            (data.recovered_flag ? '<p>Восстановление: да</p>' : '') +
            '</div>';
        })
        .catch(() => {
          app.innerHTML = '<p>Вы не зарегистрированы.</p><p><a href="/webapp/register">Регистрация</a></p>';
        });
    })();
  </script>
</body>
</html>
