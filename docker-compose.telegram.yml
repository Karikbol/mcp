# Telegram Bot Platform (client bot + WebApp)
# Client: /www/wwwroot/telegrambot/ybrjch.qgsm.store (PORT=3000)
# Admin:  /www/wwwroot/telegrambot/jqidyrb.qgsm.store (PORT=3001 Ð² .env)
# Run: docker compose -f docker-compose.telegram.yml up -d

services:
  telegram-bot:
    build:
      context: .
      dockerfile: docker/Dockerfile.telegram
    ports:
      - "127.0.0.1:${PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      WEBAPP_BASE_URL: ${WEBAPP_BASE_URL:-https://ybrjch.qgsm.store}
      BOT_TOKEN: ${BOT_TOKEN}
      ADMIN_IDS: ${ADMIN_IDS:-}
      DATABASE_URL: postgresql://telegram_bot:${POSTGRES_PASSWORD:-telegram_bot_password}@postgres:5432/telegram_bot
      SESSION_TTL_MIN: ${SESSION_TTL_MIN:-15}
      RECOVERY_TOKEN_TTL_MIN: ${RECOVERY_TOKEN_TTL_MIN:-30}
      OTP_TTL_MIN: ${OTP_TTL_MIN:-10}
      OTP_MAX_ATTEMPTS: ${OTP_MAX_ATTEMPTS:-2}
      OTP_MAX_SENDS: ${OTP_MAX_SENDS:-2}
      PIN_MAX_ATTEMPTS: ${PIN_MAX_ATTEMPTS:-3}
      RECOVERY_LOCK_HOURS: ${RECOVERY_LOCK_HOURS:-24}
      USE_POLLING: ${USE_POLLING:-false}
      WEBHOOK_PATH: ${WEBHOOK_PATH:-/telegram-webhook}
      WEBHOOK_SECRET_TOKEN: ${WEBHOOK_SECRET_TOKEN:-}
      FLOOD_PROTECTION_ENABLED: ${FLOOD_PROTECTION_ENABLED:-false}
      FLOOD_HARD_BLOCK_ENABLED: ${FLOOD_HARD_BLOCK_ENABLED:-false}
      FLOOD_WINDOW_SEC: ${FLOOD_WINDOW_SEC:-2}
      FLOOD_MAX_EVENTS: ${FLOOD_MAX_EVENTS:-5}
      FLOOD_BLOCK_MIN: ${FLOOD_BLOCK_MIN:-30}
      SMS_PROVIDER: ${SMS_PROVIDER:-mock}
      TOKEN_HASH_SECRET: ${TOKEN_HASH_SECRET:-}
      LICENSE_KEY: ${LICENSE_KEY:-}
      LICENSE_SERVER_URL: ${LICENSE_SERVER_URL:-}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: telegram_bot
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-telegram_bot_password}
      POSTGRES_DB: telegram_bot
    volumes:
      - telegram_bot_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U telegram_bot -d telegram_bot"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  telegram_bot_postgres_data:
